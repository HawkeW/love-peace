---
export interface Props {
  selector?: string;
}
const { selector = ".card img" } = Astro.props;
---
<div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-modal="true" data-selector={selector}>
  <button class="close" aria-label="关闭">×</button>
  <button class="prev" aria-label="上一张">‹</button>
  <button class="next" aria-label="下一张">›</button>
  <div class="img-container">
      <img id="lightbox-img" alt="查看大图" />
  </div>
</div>
<script>
  const lb = document.getElementById("lightbox")!;
  const img = document.getElementById("lightbox-img") as HTMLImageElement;
  const close = lb.querySelector(".close") as HTMLButtonElement;
  const prev = lb.querySelector(".prev") as HTMLButtonElement;
  const next = lb.querySelector(".next") as HTMLButtonElement;
  
  const selector = lb.dataset.selector || ".card img";
  // Delay querySelector until DOM is likely ready or use a getter
  // Ideally, this script runs after DOM content loaded or is deferred.
  // Astro scripts are modules, so they run deferred by default.
  
  let nodes: HTMLImageElement[] = [];
  let index = 0;

  const initNodes = () => {
      nodes = Array.from(document.querySelectorAll(selector)) as HTMLImageElement[];
  };

  const show = (i: number) => {
    if (nodes.length === 0) initNodes();
    // Wrap index
    if (i < 0) i = nodes.length - 1;
    if (i >= nodes.length) i = 0;
    
    index = i;
    const n = nodes[index];
    if (!n) return;
    
    // Low res placeholder first if available, or just src
    img.src = n.currentSrc || n.src;
    
    lb.setAttribute("aria-hidden", "false");
    lb.classList.add("visible");
    close.focus();
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
  };
  
  const hide = () => {
    lb.setAttribute("aria-hidden", "true");
    lb.classList.remove("visible");
    document.body.style.overflow = '';
    // Return focus to last trigger? (Optimization)
  };
  
  // Event delegation for opening lightbox (since items might be dynamic or lazy)
  document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      if (target.matches(selector)) {
          initNodes();
          const idx = nodes.indexOf(target as HTMLImageElement);
          if (idx >= 0) show(idx);
      }
  });
  
  close.addEventListener("click", hide);
  lb.addEventListener("click", (e) => {
    if (e.target === lb || (e.target as HTMLElement).classList.contains('img-container')) hide();
  });
  
  const step = (d: number) => {
    show(index + d);
  };
  
  prev.addEventListener("click", (e) => { e.stopPropagation(); step(-1); });
  next.addEventListener("click", (e) => { e.stopPropagation(); step(1); });
  
  window.addEventListener("keydown", (e) => {
    if (lb.classList.contains("visible")) {
      if (e.key === "Escape") hide();
      if (e.key === "ArrowLeft") step(-1);
      if (e.key === "ArrowRight") step(1);
    }
  });

  // Swipe Support
  let touchStartX = 0;
  let touchEndX = 0;
  
  lb.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  }, { passive: true });
  
  lb.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  }, { passive: true });
  
  function handleSwipe() {
    if (touchEndX < touchStartX - 50) step(1);
    if (touchEndX > touchStartX + 50) step(-1);
  }
</script>
<style>
  .lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.9);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity .3s ease;
    z-index: 100;
    backdrop-filter: blur(5px);
  }
  .lightbox.visible {
    opacity: 1;
    pointer-events: auto;
  }
  
  .img-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
  }

  .lightbox img {
    max-width: 95vw;
    max-height: 90vh;
    box-shadow: 0 20px 50px rgba(0,0,0,.8);
    border-radius: 4px;
    object-fit: contain;
    user-select: none;
  }
  
  .lightbox .close,
  .lightbox .prev,
  .lightbox .next {
    position: absolute;
    background: rgba(255,255,255,.2);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    z-index: 101;
  }
  
  .lightbox .close:hover,
  .lightbox .prev:hover,
  .lightbox .next:hover {
      background: rgba(255,255,255,0.4);
  }

  .lightbox .close { top: 20px; right: 20px; }
  .lightbox .prev { left: 20px; top: 50%; transform: translateY(-50%); }
  .lightbox .next { right: 20px; top: 50%; transform: translateY(-50%); }
  
  @media (max-width: 640px) {
    .lightbox img { max-width: 100vw; max-height: 80vh; border-radius: 0; }
    .lightbox .prev, .lightbox .next { display: none; } /* Use swipe on mobile */
  }
</style>
