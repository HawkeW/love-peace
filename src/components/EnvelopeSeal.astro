---
export interface Props {
  text?: string;
}

const sealImage = "/seal.png";
---

<div class="envelope-seal-wrapper" data-envelope-seal>
  <figure class="seal-image">
    <img src={sealImage} alt="开启邀请函" decoding="async" />
  </figure>

  <span class="seal-hint">轻触开启</span>
</div>

<script>
  const sealWrapper = document.querySelector(
    "[data-envelope-seal]"
  ) as HTMLElement;
  const seal = sealWrapper?.querySelector(".seal-image") as HTMLElement;
  const heroSection = document.querySelector(".parallax-hero") as HTMLElement;

  if (seal && sealWrapper) {
    let isAnimating = false;

    // Hide on scroll
    let hidden = false;
    window.addEventListener(
      "scroll",
      () => {
        if (window.scrollY > 100 && !hidden) {
          sealWrapper.classList.add("hidden");
          hidden = true;
        } else if (window.scrollY <= 100 && hidden) {
          sealWrapper.classList.remove("hidden");
          hidden = false;
        }
      },
      { passive: true }
    );

    // Click handler - 简洁自然的过渡
    seal.addEventListener("click", () => {
      if (isAnimating) return;
      isAnimating = true;

      // 火漆印按下旋转效果
      seal.classList.add("opening");

      // 首屏内容淡出
      if (heroSection) {
        heroSection.classList.add("transitioning");
      }

      // 延迟滚动到第二屏
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent("envelope-opened"));
      }, 400);

      // 清理状态
      setTimeout(() => {
        seal.classList.remove("opening");
        if (heroSection) {
          heroSection.classList.remove("transitioning");
        }
        isAnimating = false;
      }, 1200);
    });
  }
</script>

<style>
  .envelope-seal-wrapper {
    position: relative;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    opacity: 0;
    animation: sealFadeIn 0.8s ease-out 1.5s forwards;
  }

  @keyframes sealFadeIn {
    from {
      opacity: 0;
      transform: translateY(16px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .envelope-seal-wrapper.hidden {
    opacity: 0;
    pointer-events: none;
    transform: translateY(20px);
    transition:
      opacity 0.4s ease,
      transform 0.4s ease;
  }

  /* Seal Image */
  .seal-image {
    position: relative;
    margin: 0;
    cursor: pointer;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .seal-image img {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    display: block;
    object-fit: cover;
    filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.25));
    transition:
      filter 0.3s ease,
      transform 0.3s ease;
  }

  .seal-image:hover {
    transform: scale(1.08);
  }

  .seal-image:hover img {
    filter: drop-shadow(0 6px 20px rgba(0, 0, 0, 0.35));
  }

  /* 火漆印开启动画 - 缩小旋转淡出 */
  .seal-image.opening {
    animation: sealOpen 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  @keyframes sealOpen {
    0% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
    50% {
      transform: scale(0.8) rotate(180deg);
      opacity: 0.8;
    }
    100% {
      transform: scale(0) rotate(360deg);
      opacity: 0;
    }
  }

  /* Hint text */
  .seal-hint {
    font-family: "Dongjingjiejiao", Georgia, serif;
    font-size: 12px;
    letter-spacing: 0.2em;
    color: var(--text-secondary, #a0a0a0);
    opacity: 0;
    animation: hintFadeIn 0.6s ease-out 2s forwards;
    transition:
      opacity 0.3s ease,
      color 0.3s ease;
  }

  @keyframes hintFadeIn {
    to {
      opacity: 0.6;
    }
  }

  .envelope-seal-wrapper:hover .seal-hint {
    opacity: 1;
    color: var(--gold, #c9a962);
  }

  /* 开启时提示文字淡出 */
  .seal-image.opening ~ .seal-hint {
    opacity: 0 !important;
    transition: opacity 0.3s ease;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .envelope-seal-wrapper {
      gap: 10px;
    }

    .seal-image img {
      width: 56px;
      height: 56px;
    }

    .seal-hint {
      font-size: 10px;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .envelope-seal-wrapper {
      opacity: 1;
      animation: none;
    }

    .seal-hint {
      opacity: 0.6;
      animation: none;
    }

    .seal-image,
    .seal-image img {
      transition: none;
    }

    .seal-image.opening {
      animation: none;
      opacity: 0;
    }
  }
</style>
