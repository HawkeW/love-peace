---
interface Props {
  videoSrc: string;
  videoPoster?: string;
  title?: string;
  subtitle?: string;
}

const { videoSrc, videoPoster, title, subtitle } = Astro.props;
---

<section id="simple-video-section" class="simple-video-section">
  <div class="video-container">
    <video 
      id="simple-video"
      class="video-element" 
      preload="auto"
      playsinline
      muted
      src={videoSrc}
      poster={videoPoster}
    ></video>
    
    <div class="video-overlay">
      <div class="overlay-content">
        {title && <h2 class="video-title">{title}</h2>}
        {subtitle && <p class="video-subtitle">{subtitle}</p>}
        
        <!-- ç®€åŒ–çš„è°ƒè¯•ä¿¡æ¯ -->
        <div class="debug-simple">
          <div>è¿›åº¦: <span id="simple-progress">0%</span></div>
          <div>æ—¶é—´: <span id="simple-time">0s</span></div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  async function initSimpleVideoScroll() {
    console.log('ğŸš€ åˆå§‹åŒ–ç®€å•è§†é¢‘æ»šåŠ¨');
    
    // åŠ¨æ€åŠ è½½GSAP
    if (typeof window.gsap === 'undefined') {
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    if (typeof window.ScrollTrigger === 'undefined') {
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // ç­‰å¾…GSAPå®Œå…¨åŠ è½½
    await new Promise(resolve => setTimeout(resolve, 100));
    
    if (!window.gsap || !window.ScrollTrigger) {
      console.error('âŒ GSAPåŠ è½½å¤±è´¥');
      return;
    }

    window.gsap.registerPlugin(window.ScrollTrigger);
    console.log('âœ… GSAPå·²åŠ è½½å¹¶æ³¨å†Œ');

    const section = document.getElementById('simple-video-section');
    const video = document.getElementById('simple-video') as HTMLVideoElement;
    const progressEl = document.getElementById('simple-progress');
    const timeEl = document.getElementById('simple-time');
    
    if (!section || !video) {
      console.error('âŒ æ‰¾ä¸åˆ°å…ƒç´ ');
      return;
    }

    let isReady = false;
    let duration = 0;

    // ç­‰å¾…è§†é¢‘å‡†å¤‡å°±ç»ª
    const waitForVideo = () => {
      return new Promise<void>((resolve) => {
        const checkReady = () => {
          if (video.readyState >= 1 && video.duration > 0) {
            duration = video.duration;
            isReady = true;
            console.log('âœ… è§†é¢‘å‡†å¤‡å°±ç»ªï¼Œæ—¶é•¿:', duration);
            resolve();
          } else {
            setTimeout(checkReady, 100);
          }
        };
        checkReady();
      });
    };

    // å¼ºåˆ¶åŠ è½½è§†é¢‘
    video.load();
    
    // å°è¯•æ’­æ”¾ç„¶åæš‚åœ
    try {
      await video.play();
      video.pause();
      video.currentTime = 0;
      console.log('âœ… è§†é¢‘æ’­æ”¾æµ‹è¯•æˆåŠŸ');
    } catch (e) {
      console.log('âš ï¸ è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼ˆæ­£å¸¸ï¼‰');
    }

    // ç­‰å¾…è§†é¢‘å‡†å¤‡å°±ç»ª
    await waitForVideo();

    // åˆ›å»ºScrollTrigger - ä½¿ç”¨æœ€ç®€å•çš„é…ç½®
    window.ScrollTrigger.create({
      trigger: section,
      start: 'top top',
      end: 'bottom top',
      pin: true,
      scrub: 0.5,
      markers: true,
      
      onUpdate: (self: any) => {
        if (!isReady) return;
        
        const progress = self.progress;
        const targetTime = progress * duration;
        
        // ç›´æ¥è®¾ç½®è§†é¢‘æ—¶é—´
        video.currentTime = targetTime;
        
        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        if (progressEl) progressEl.textContent = Math.round(progress * 100) + '%';
        if (timeEl) timeEl.textContent = targetTime.toFixed(1) + 's / ' + duration.toFixed(1) + 's';
        
        console.log('ğŸ“Š è¿›åº¦:', progress.toFixed(3), 'æ—¶é—´:', targetTime.toFixed(3));
      }
    });

    console.log('âœ… ScrollTriggerè®¾ç½®å®Œæˆ');
  }

  // å¯åŠ¨
  initSimpleVideoScroll().catch(console.error);
</script>

<style>
  .simple-video-section {
    height: 100vh;
    position: relative;
    background: #000;
  }

  .video-container {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .video-element {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 10;
  }

  .overlay-content {
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    color: white;
  }

  .video-title {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #c9a962;
  }

  .video-subtitle {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: #e8d5a3;
  }

  .debug-simple {
    margin-top: 20px;
    font-family: monospace;
    font-size: 14px;
    color: #666;
  }

  .debug-simple div {
    margin-bottom: 5px;
  }
</style>