---
interface Props {
  videoSrc: string;
  videoPoster?: string;
  title?: string;
  subtitle?: string;
}

const { videoSrc, videoPoster, title, subtitle } = Astro.props;
---

<section id="fixed-video-section" class="fixed-video-section">
  <!-- å›ºå®šçš„è§†é¢‘å®¹å™¨ -->
  <div class="video-pin-container">
    <video 
      id="fixed-video"
      class="video-element" 
      preload="auto"
      playsinline
      muted
      src={videoSrc}
      poster={videoPoster}
    ></video>
    
    <div class="video-overlay">
      <div class="overlay-content">
        {title && <h2 class="video-title">{title}</h2>}
        {subtitle && <p class="video-subtitle">{subtitle}</p>}
        
        <div class="debug-info">
          <div>çŠ¶æ€: <span id="fixed-status">åˆå§‹åŒ–ä¸­</span></div>
          <div>è¿›åº¦: <span id="fixed-progress">0%</span></div>
          <div>æ—¶é—´: <span id="fixed-time">0s / 0s</span></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æ»šåŠ¨å ä½ç©ºé—´ -->
  <div class="scroll-spacer"></div>
</section>

<script>
  async function initFixedVideoScroll() {
    console.log('ğŸš€ åˆå§‹åŒ–ä¿®å¤ç‰ˆè§†é¢‘æ»šåŠ¨');
    
    // åŠ¨æ€åŠ è½½GSAP
    if (typeof window.gsap === 'undefined') {
      const script1 = document.createElement('script');
      script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js';
      document.head.appendChild(script1);
      await new Promise(resolve => script1.onload = resolve);
    }

    if (typeof window.ScrollTrigger === 'undefined') {
      const script2 = document.createElement('script');
      script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js';
      document.head.appendChild(script2);
      await new Promise(resolve => script2.onload = resolve);
    }

    await new Promise(resolve => setTimeout(resolve, 200));
    
    if (!window.gsap || !window.ScrollTrigger) {
      console.error('âŒ GSAPåŠ è½½å¤±è´¥');
      return;
    }

    window.gsap.registerPlugin(window.ScrollTrigger);
    console.log('âœ… GSAPå·²åŠ è½½');

    const section = document.getElementById('fixed-video-section');
    const video = document.getElementById('fixed-video') as HTMLVideoElement;
    const statusEl = document.getElementById('fixed-status');
    const progressEl = document.getElementById('fixed-progress');
    const timeEl = document.getElementById('fixed-time');
    
    if (!section || !video) {
      console.error('âŒ æ‰¾ä¸åˆ°å…ƒç´ ');
      return;
    }

    let isReady = false;
    let duration = 0;

    function updateDebug(status: string, progress: number, currentTime: number, totalTime: number) {
      if (statusEl) statusEl.textContent = status;
      if (progressEl) progressEl.textContent = Math.round(progress * 100) + '%';
      if (timeEl) timeEl.textContent = `${currentTime.toFixed(1)}s / ${totalTime.toFixed(1)}s`;
    }

    // è§†é¢‘å‡†å¤‡
    const prepareVideo = async () => {
      console.log('ğŸ¥ å‡†å¤‡è§†é¢‘...');
      updateDebug('åŠ è½½ä¸­', 0, 0, 0);
      
      // å¼ºåˆ¶åŠ è½½
      video.load();
      
      // ç­‰å¾…å…ƒæ•°æ®
      await new Promise<void>((resolve) => {
        const checkReady = () => {
          console.log('æ£€æŸ¥è§†é¢‘çŠ¶æ€:', video.readyState, video.duration);
          if (video.readyState >= 1 && video.duration > 0) {
            duration = video.duration;
            console.log('âœ… è§†é¢‘å‡†å¤‡å°±ç»ªï¼Œæ—¶é•¿:', duration);
            updateDebug('å‡†å¤‡å°±ç»ª', 0, 0, duration);
            resolve();
          } else {
            setTimeout(checkReady, 100);
          }
        };
        
        video.addEventListener('loadedmetadata', checkReady);
        video.addEventListener('loadeddata', checkReady);
        checkReady();
      });

      // æµ‹è¯•æ’­æ”¾
      try {
        await video.play();
        console.log('âœ… è§†é¢‘å¯ä»¥æ’­æ”¾');
        video.pause();
        video.currentTime = 0;
        updateDebug('æ’­æ”¾æµ‹è¯•æˆåŠŸ', 0, 0, duration);
      } catch (e) {
        console.log('âš ï¸ è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼ˆæ­£å¸¸ï¼‰');
        updateDebug('æ’­æ”¾è¢«é˜»æ­¢', 0, 0, duration);
      }

      isReady = true;
      return duration;
    };

    // å‡†å¤‡è§†é¢‘
    await prepareVideo();

    // åˆ›å»ºScrollTrigger
    console.log('ğŸ¯ åˆ›å»ºScrollTrigger...');
    
    const scrollTrigger = window.ScrollTrigger.create({
      trigger: section,
      pin: '.video-pin-container',
      start: 'top top',
      end: '+=300vh', // 3ä¸ªè§†å£é«˜åº¦çš„æ»šåŠ¨è·ç¦»
      scrub: 1,
      markers: true,
      pinSpacing: false,
      anticipatePin: 1,
      
      onUpdate: (self: any) => {
        if (!isReady || duration <= 0) return;
        
        const progress = self.progress;
        const targetTime = progress * duration;
        
        // è®¾ç½®è§†é¢‘æ—¶é—´
        if (Math.abs(video.currentTime - targetTime) > 0.1) {
          video.currentTime = targetTime;
        }
        
        updateDebug('æ’­æ”¾ä¸­', progress, targetTime, duration);
        console.log('ğŸ“Š æ»šåŠ¨è¿›åº¦:', progress.toFixed(3), 'è§†é¢‘æ—¶é—´:', targetTime.toFixed(3));
      },
      
      onEnter: () => {
        console.log('ğŸ¬ è¿›å…¥è§†é¢‘åŒºåŸŸ');
        updateDebug('è¿›å…¥åŒºåŸŸ', 0, 0, duration);
      },
      
      onLeave: () => {
        console.log('ğŸ¬ ç¦»å¼€è§†é¢‘åŒºåŸŸ');
        updateDebug('ç¦»å¼€åŒºåŸŸ', 1, duration, duration);
      }
    });

    console.log('âœ… ScrollTriggeråˆ›å»ºå®Œæˆ');

    // çª—å£å¤§å°æ”¹å˜æ—¶åˆ·æ–°
    window.addEventListener('resize', () => {
      window.ScrollTrigger.refresh();
    });
  }

  // å¯åŠ¨
  initFixedVideoScroll().catch(console.error);
</script>

<style>
  .fixed-video-section {
    position: relative;
  }

  .video-pin-container {
    width: 100%;
    height: 100vh;
    position: relative;
    background: #000;
  }

  .video-element {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    background: #000;
  }

  /* ç¡®ä¿è§†é¢‘ä¸ä¼šé—ªçƒ */
  .video-element::-webkit-media-controls {
    display: none !important;
  }

  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 10;
  }

  .overlay-content {
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 30px;
    text-align: center;
    color: white;
    max-width: 600px;
    margin: 0 20px;
  }

  .video-title {
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    margin-bottom: 1rem;
    color: #c9a962;
    font-weight: 500;
  }

  .video-subtitle {
    font-size: clamp(1rem, 2.5vw, 1.25rem);
    margin-bottom: 1.5rem;
    color: #e8d5a3;
    line-height: 1.6;
  }

  .debug-info {
    margin-top: 20px;
    font-family: monospace;
    font-size: 12px;
    color: #888;
    text-align: left;
  }

  .debug-info div {
    margin-bottom: 5px;
  }

  /* æ»šåŠ¨å ä½ç©ºé—´ - è¿™å¾ˆé‡è¦ï¼ */
  .scroll-spacer {
    height: 300vh; /* ä¸ScrollTriggerçš„endä¿æŒä¸€è‡´ */
    background: transparent;
    pointer-events: none;
  }

  /* å“åº”å¼ */
  @media (max-width: 768px) {
    .overlay-content {
      padding: 20px;
    }
    
    .debug-info {
      font-size: 10px;
    }
  }
</style>