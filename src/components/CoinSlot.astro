---
// CoinSlot.astro - Ë∂£Âë≥ÊäïÂ∏Å‰∫§‰∫íÁªÑ‰ª∂
---

<div class="coin-slot" id="coinSlot">
  <!-- ÂàùÂßãÁä∂ÊÄÅÔºöÊäïÂ∏ÅÊåâÈíÆ -->
  <button class="coin-btn" id="coinBtn">
    <span class="coin-icon">ü™ô</span>
    <span class="coin-text">Êäï‰∏™Â∏Å</span>
  </button>
  
  <!-- ÈÄâÊã©ÊäïÂá†‰∏™Â∏Å -->
  <div class="coin-options" id="coinOptions">
    <p class="options-title">ÊäïÂá†‰∏™Â∏ÅÔºü</p>
    <div class="options-btns">
      <button class="option-btn" data-coins="1">
        <span>ü™ô</span>
        <span>‰∏Ä‰∏™</span>
      </button>
      <button class="option-btn" data-coins="2">
        <span>ü™ôü™ô</span>
        <span>‰∏§‰∏™</span>
      </button>
    </div>
  </div>
  
  <!-- ÊäïÂ∏ÅÂä®Áîª -->
  <div class="coin-animation" id="coinAnimation">
    <div class="falling-coins"></div>
    <div class="slot-machine">
      <div class="slot-opening"></div>
    </div>
  </div>
  
  <!-- Á•ùÁ¶èÂºπÁ™ó -->
  <div class="blessing-modal" id="blessingModal">
    <div class="blessing-card">
      <div class="blessing-icon">üíù</div>
      <p class="blessing-text" id="blessingText"></p>
      <button class="blessing-close" id="blessingClose">ÂºÄÂßãÊµèËßà</button>
    </div>
  </div>
</div>

<script>
  const blessings = [
    'Á•ù‰Ω†‰ª¨ÁôæÂπ¥Â•ΩÂêàÔºåÊ∞∏ÁªìÂêåÂøÉÔºÅ',
    'ÊÑø‰Ω†‰ª¨ÁöÑÁà±ÊÉÖÂ¶ÇËØóÂ¶ÇÁîªÔºåÂ≤ÅÊúàÈùôÂ•ΩÔΩû',
    'Á•ùÁ¶è‰Ω†‰ª¨ÁôΩÂ§¥ÂÅïËÄÅÔºåÂπ∏Á¶èÁæéÊª°ÔºÅ',
    'ÊÑøÁà±‰∏éÂπ∏Á¶èÊ∞∏Ëøú‰º¥Èöè‰Ω†‰ª¨Â∑¶Âè≥ÔΩû',
    'Á•ùÊñ∞Â©öÂø´‰πêÔºåÊó©ÁîüË¥µÂ≠êÔºÅ',
    'ÊÑø‰Ω†‰ª¨ÁöÑÊØè‰∏ÄÂ§©ÈÉΩÂÖÖÊª°ÁîúËúúÔºÅ',
    'Á•ùÁ¶è‰Ω†‰ª¨Êê∫ÊâãÂÖ±Â∫¶ÁæéÂ•Ω‰∫∫ÁîüÔΩû',
    'ÊÑø‰Ω†‰ª¨ÁöÑÁà±ÊÉÖÊïÖ‰∫ãÊ∞∏ËøúÁ≤æÂΩ©ÔºÅ'
  ];
  
  const coinBtn = document.getElementById('coinBtn')!;
  const coinOptions = document.getElementById('coinOptions')!;
  const coinAnimation = document.getElementById('coinAnimation')!;
  const blessingModal = document.getElementById('blessingModal')!;
  const blessingText = document.getElementById('blessingText')!;
  const blessingClose = document.getElementById('blessingClose')!;
  const optionBtns = document.querySelectorAll('.option-btn');
  const fallingCoins = document.querySelector('.falling-coins')!;
  
  let coinCount = 0;
  
  // ÁÇπÂáªÊäïÂ∏ÅÊåâÈíÆ
  coinBtn.addEventListener('click', () => {
    coinBtn.classList.add('hidden');
    coinOptions.classList.add('show');
  });
  
  // ÈÄâÊã©ÊäïÂá†‰∏™Â∏Å
  optionBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      coinCount = parseInt(btn.getAttribute('data-coins') || '1');
      coinOptions.classList.remove('show');
      startCoinAnimation(coinCount);
    });
  });
  
  // ÊäïÂ∏ÅÂä®Áîª
  function startCoinAnimation(count: number) {
    coinAnimation.classList.add('show');
    fallingCoins.innerHTML = '';
    
    // ÂàõÂª∫ÊéâËêΩÁöÑÁ°¨Â∏Å
    for (let i = 0; i < count; i++) {
      const coin = document.createElement('div');
      coin.className = 'coin';
      coin.style.animationDelay = `${i * 200}ms`;
      coin.textContent = 'ü™ô';
      fallingCoins.appendChild(coin);
    }
    
    // Êí≠ÊîæÈü≥ÊïàÔºàÂèØÈÄâÔºâ
    playSound();
    
    // Âä®ÁîªÁªìÊùüÂêéÊòæÁ§∫Á•ùÁ¶è
    setTimeout(() => {
      coinAnimation.classList.remove('show');
      showBlessing();
    }, 1200 + (count - 1) * 200);
  }
  
  // ÊòæÁ§∫Á•ùÁ¶è
  function showBlessing() {
    const randomBlessing = blessings[Math.floor(Math.random() * blessings.length)];
    blessingText.textContent = randomBlessing;
    blessingModal.classList.add('show');
  }
  
  // ÂÖ≥Èó≠Á•ùÁ¶èÔºåÂºÄÂßãÊµèËßà
  blessingClose.addEventListener('click', () => {
    blessingModal.classList.remove('show');
    document.getElementById('coinSlot')?.classList.add('completed');
    
    // ÊªöÂä®Âà∞ÊïÖ‰∫ãÂå∫Âüü
    const storySection = document.getElementById('story') || document.querySelector('.slide[data-index="1"]');
    if (storySection) {
      storySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
  
  // ÁÆÄÂçïÁöÑÈü≥Êïà
  function playSound() {
    try {
      const audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
      
      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.3);
    } catch (e) {
      // ÈùôÈªòÂ§±Ë¥•
    }
  }
</script>

<style>
  .coin-slot {
    position: absolute;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .coin-slot.completed {
    display: none;
  }
  
  /* ÊäïÂ∏ÅÊåâÈíÆ */
  .coin-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 16px 28px;
    background: linear-gradient(145deg, #ffd700, #ffb800);
    border: none;
    border-radius: 16px;
    cursor: pointer;
    box-shadow: 
      0 4px 0 #cc9200,
      0 8px 20px rgba(0,0,0,0.3),
      inset 0 2px 4px rgba(255,255,255,0.4);
    transition: all 0.15s ease;
    animation: float 2s ease-in-out infinite;
  }
  
  .coin-btn:hover {
    transform: translateY(-2px);
    box-shadow: 
      0 6px 0 #cc9200,
      0 12px 24px rgba(0,0,0,0.35),
      inset 0 2px 4px rgba(255,255,255,0.4);
  }
  
  .coin-btn:active {
    transform: translateY(2px);
    box-shadow: 
      0 2px 0 #cc9200,
      0 4px 12px rgba(0,0,0,0.25),
      inset 0 2px 4px rgba(255,255,255,0.4);
  }
  
  .coin-btn.hidden {
    display: none;
  }
  
  .coin-icon {
    font-size: 32px;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
  }
  
  .coin-text {
    font-size: 15px;
    font-weight: 600;
    color: #5c4813;
    letter-spacing: 0.05em;
  }
  
  /* ÈÄâÈ°πÈù¢Êùø */
  .coin-options {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 20px 24px;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(255,215,0,0.3);
  }
  
  .coin-options.show {
    display: flex;
    animation: popIn 0.3s ease;
  }
  
  .options-title {
    margin: 0;
    font-size: 15px;
    color: rgba(255,255,255,0.9);
    letter-spacing: 0.05em;
  }
  
  .options-btns {
    display: flex;
    gap: 12px;
  }
  
  .option-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 14px 22px;
    background: linear-gradient(145deg, #ffd700, #ffb800);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #5c4813;
    box-shadow: 0 3px 0 #cc9200, 0 6px 16px rgba(0,0,0,0.2);
    transition: all 0.15s ease;
  }
  
  .option-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 0 #cc9200, 0 8px 20px rgba(0,0,0,0.25);
  }
  
  .option-btn:active {
    transform: translateY(2px);
    box-shadow: 0 1px 0 #cc9200, 0 3px 10px rgba(0,0,0,0.2);
  }
  
  .option-btn span:first-child {
    font-size: 24px;
  }
  
  /* ÊäïÂ∏ÅÂä®Áîª */
  .coin-animation {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 100;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
  }
  
  .coin-animation.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .falling-coins {
    position: absolute;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
  }
  
  .coin {
    font-size: 48px;
    animation: coinFall 0.8s ease-in forwards;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
  }
  
  .slot-machine {
    width: 120px;
    height: 80px;
    background: linear-gradient(180deg, #4a4a4a, #2a2a2a);
    border-radius: 12px;
    position: relative;
    box-shadow: 
      inset 0 4px 8px rgba(0,0,0,0.5),
      0 8px 24px rgba(0,0,0,0.4);
  }
  
  .slot-opening {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 50px;
    height: 8px;
    background: #000;
    border-radius: 4px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.8);
  }
  
  /* Á•ùÁ¶èÂºπÁ™ó */
  .blessing-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 200;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
  }
  
  .blessing-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.4s ease;
  }
  
  .blessing-card {
    width: min(85vw, 320px);
    padding: 32px 24px;
    background: linear-gradient(160deg, #fff9e6, #fff);
    border-radius: 24px;
    text-align: center;
    box-shadow: 
      0 20px 60px rgba(0,0,0,0.3),
      0 0 0 1px rgba(255,215,0,0.2);
    animation: cardPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .blessing-icon {
    font-size: 56px;
    margin-bottom: 16px;
    animation: pulse 1s ease-in-out infinite;
  }
  
  .blessing-text {
    margin: 0 0 24px;
    font-size: 18px;
    line-height: 1.6;
    color: #333;
    font-weight: 500;
  }
  
  .blessing-close {
    padding: 14px 32px;
    background: linear-gradient(145deg, #e94e77, #d63d66);
    border: none;
    border-radius: 999px;
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(233, 78, 119, 0.4);
    transition: all 0.2s ease;
  }
  
  .blessing-close:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(233, 78, 119, 0.5);
  }
  
  /* Âä®Áîª */
  @keyframes float {
    0%, 100% { transform: translateX(-50%) translateY(0); }
    50% { transform: translateX(-50%) translateY(-8px); }
  }
  
  @keyframes popIn {
    from { 
      opacity: 0; 
      transform: scale(0.8); 
    }
    to { 
      opacity: 1; 
      transform: scale(1); 
    }
  }
  
  @keyframes coinFall {
    0% {
      transform: translateY(0) rotate(0deg);
      opacity: 1;
    }
    80% {
      opacity: 1;
    }
    100% {
      transform: translateY(200px) rotate(720deg);
      opacity: 0;
    }
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes cardPop {
    from {
      opacity: 0;
      transform: scale(0.6) translateY(40px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
</style>
