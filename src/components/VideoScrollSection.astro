---
interface Props {
  videoSrc: string;
  videoPoster?: string;
  title?: string;
  subtitle?: string;
  scrollDistance?: number; // æ»šåŠ¨è·ç¦»å€æ•°ï¼Œé»˜è®¤3
  scrubSpeed?: number; // scrubé€Ÿåº¦ï¼Œé»˜è®¤0.5
  showDebug?: boolean; // æ˜¯å¦æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
}

const { 
  videoSrc, 
  videoPoster, 
  title, 
  subtitle,
  scrollDistance = 3,
  scrubSpeed = 0.5,
  showDebug = false
} = Astro.props;
---

<section id="video-scroll-section" class="video-scroll-section">
  <div class="video-pinned-container">
    <!-- Video Container -->
    <div class="video-media-container">
      <video 
        id="scroll-video"
        class="scroll-video" 
        tabindex="-1" 
        width="1920" 
        height="1080" 
        preload="auto"
        playsinline
        muted
        src={videoSrc}
        poster={videoPoster}
      ></video>
    </div>
    
    <!-- Overlay Content -->
    <div class="video-overlay-container">
      <div class="video-overlay-wrapper">
        <div class="video-overlay-content">
          {title && <h2 class="video-title">{title}</h2>}
          {subtitle && <p class="video-subtitle">{subtitle}</p>}
          
          {showDebug && (
            <div class="debug-info">
              <div>çŠ¶æ€: <span id="video-status">åˆå§‹åŒ–ä¸­...</span></div>
              <div>è¿›åº¦: <span id="scroll-progress">0%</span></div>
              <div>æ—¶é—´: <span id="video-time">0s / 0s</span></div>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ scrollDistance, scrubSpeed, showDebug }}>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  // æ³¨å†ŒScrollTriggeræ’ä»¶
  gsap.registerPlugin(ScrollTrigger);

  // Lenis æ£€æµ‹å‡½æ•°
  function detectLenis() {
    try {
      // æ£€æŸ¥å…¨å±€ window.lenis å®ä¾‹
      if (typeof window !== 'undefined' && window.lenis) {
        const lenis = window.lenis;
        
        // éªŒè¯ Lenis å®ä¾‹æ˜¯å¦æœ‰å¿…éœ€çš„æ–¹æ³•
        if (typeof lenis.on === 'function' && typeof lenis.raf === 'function') {
          console.log('ğŸ” [Lenis Detection] Lenis å®ä¾‹å·²æ£€æµ‹åˆ°');
          return lenis;
        } else {
          console.warn('ğŸ” [Lenis Detection] window.lenis å­˜åœ¨ä½†ç¼ºå°‘å¿…éœ€æ–¹æ³•');
          return null;
        }
      }
      
      console.log('ğŸ” [Lenis Detection] æœªæ£€æµ‹åˆ° Lenisï¼Œä½¿ç”¨åŸç”Ÿæ»šåŠ¨');
      return null;
    } catch (error) {
      console.warn('ğŸ” [Lenis Detection] æ£€æµ‹è¿‡ç¨‹å‡ºé”™:', error);
      return null;
    }
  }

  // Lenis åŒæ­¥å‡½æ•°
  function setupLenisSync(lenis) {
    try {
      console.log('ğŸ”— [Lenis Sync] å¼€å§‹é…ç½® Lenis ä¸ GSAP ScrollTrigger åŒæ­¥...');
      
      // æ­¥éª¤ 1: ç»‘å®š Lenis æ»šåŠ¨äº‹ä»¶åˆ° ScrollTrigger
      // è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œç¡®ä¿ ScrollTrigger èƒ½æ¥æ”¶åˆ° Lenis çš„æ»šåŠ¨æ›´æ–°
      lenis.on('scroll', ScrollTrigger.update);
      console.log('ğŸ”— [Lenis Sync] âœ“ å·²ç»‘å®šæ»šåŠ¨äº‹ä»¶');
      
      // æ­¥éª¤ 2: ç¦ç”¨ GSAP å»¶è¿Ÿå¹³æ»‘
      // è¿™å¯ä»¥é˜²æ­¢ GSAP å°è¯•è¡¥å¿å¸§ç‡ä¸‹é™ï¼Œä¸ Lenis çš„å¹³æ»‘æ»šåŠ¨å†²çª
      gsap.ticker.lagSmoothing(0);
      console.log('ğŸ”— [Lenis Sync] âœ“ å·²ç¦ç”¨å»¶è¿Ÿå¹³æ»‘');
      
      // æ³¨æ„ï¼šä¸éœ€è¦å†æ¬¡è°ƒç”¨ lenis.raf()ï¼Œå› ä¸ºé¡µé¢å·²ç»æœ‰è‡ªå·±çš„ RAF å¾ªç¯
      // é‡å¤è°ƒç”¨ä¼šå¯¼è‡´å†²çªå’Œæ€§èƒ½é—®é¢˜
      
      console.log('âœ… [Lenis Sync] Lenis åŒæ­¥é…ç½®å®Œæˆ');
    } catch (error) {
      console.error('âŒ [Lenis Sync] åŒæ­¥é…ç½®å¤±è´¥:', error);
      throw error;
    }
  }

  // è°ƒè¯•å‡½æ•°
  function updateDebugInfo(status, progress, currentTime, duration) {
    if (!showDebug) return;
    
    const statusEl = document.getElementById('video-status');
    const progressEl = document.getElementById('scroll-progress');
    const timeEl = document.getElementById('video-time');
    
    if (statusEl) statusEl.textContent = status;
    if (progressEl) progressEl.textContent = Math.round(progress * 100) + '%';
    if (timeEl) timeEl.textContent = currentTime.toFixed(1) + 's / ' + duration.toFixed(1) + 's';
  }

  // ä¸»åˆå§‹åŒ–å‡½æ•°
  async function initVideoScroll() {
    try {
      console.log('ğŸ¬ åˆå§‹åŒ–è§†é¢‘æ»šåŠ¨ç»„ä»¶...');

      // æ£€æµ‹ Lenis å®ä¾‹
      const lenisInstance = detectLenis();
      
      // å¦‚æœæ£€æµ‹åˆ° Lenisï¼Œé…ç½®åŒæ­¥
      if (lenisInstance) {
        try {
          setupLenisSync(lenisInstance);
        } catch (syncError) {
          console.error('âŒ [Error] Lenis åŒæ­¥å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸç”Ÿæ»šåŠ¨:', syncError);
        }
      }

      const videoSection = document.getElementById('video-scroll-section');
      const video = document.getElementById('scroll-video');
      
      if (!videoSection || !video) {
        console.error('âŒ æ‰¾ä¸åˆ°è§†é¢‘å…ƒç´ ');
        return;
      }

      console.log('âœ… æ‰¾åˆ°è§†é¢‘å…ƒç´ ');
      updateDebugInfo('åŠ è½½è§†é¢‘', 0, 0, 0);

      let videoDuration = 0;

      // å¼ºåˆ¶åŠ è½½è§†é¢‘
      video.load();

      // ç­‰å¾…è§†é¢‘å‡†å¤‡å°±ç»ª
      await new Promise((resolve) => {
        const checkReady = () => {
          if (video.readyState >= 1 && video.duration > 0) {
            videoDuration = video.duration;
            console.log('âœ… è§†é¢‘å‡†å¤‡å°±ç»ªï¼Œæ—¶é•¿:', videoDuration + 's');
            resolve();
          } else {
            setTimeout(checkReady, 100);
          }
        };
        
        video.addEventListener('loadedmetadata', checkReady);
        video.addEventListener('loadeddata', checkReady);
        checkReady();
      });

      updateDebugInfo('å‡†å¤‡å°±ç»ª', 0, 0, videoDuration);

      // æµ‹è¯•æ’­æ”¾
      try {
        await video.play();
        console.log('âœ… è§†é¢‘å¯ä»¥æ’­æ”¾');
        video.pause();
        video.currentTime = 0;
      } catch (e) {
        console.log('âš ï¸ è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼ˆæ­£å¸¸ï¼‰');
      }

      // åˆ›å»ºScrollTrigger
      console.log('ğŸ¯ åˆ›å»ºScrollTrigger...');
      
      const vh = window.innerHeight;
      const scrollDist = vh * scrollDistance;
      
      ScrollTrigger.create({
        trigger: videoSection,
        pin: '.video-pinned-container',
        pinSpacing: false,
        scrub: scrubSpeed,
        start: 'top top',
        end: '+=' + scrollDist + 'px',
        anticipatePin: 1,
        invalidateOnRefresh: true,
        
        onUpdate: (self) => {
          const progress = self.progress;
          const targetTime = progress * videoDuration;
          
          video.currentTime = targetTime;
          updateDebugInfo('æ’­æ”¾ä¸­', progress, targetTime, videoDuration);
          
          if (showDebug) {
            console.log('ğŸ“Š è¿›åº¦:', progress.toFixed(3), 'æ—¶é—´:', targetTime.toFixed(3));
          }
        },
        
        onEnter: () => {
          console.log('ğŸ¬ è¿›å…¥è§†é¢‘åŒºåŸŸ');
          updateDebugInfo('è¿›å…¥åŒºåŸŸ', 0, 0, videoDuration);
          if (!video.paused) {
            video.pause();
          }
        },
        
        onLeave: () => {
          console.log('ğŸ¬ ç¦»å¼€è§†é¢‘åŒºåŸŸï¼ˆå‘ä¸‹ï¼‰');
          updateDebugInfo('ç¦»å¼€åŒºåŸŸ', 1, videoDuration, videoDuration);
          if (videoDuration > 0) {
            video.currentTime = videoDuration;
          }
        },
        
        onEnterBack: () => {
          console.log('ğŸ¬ é‡æ–°è¿›å…¥è§†é¢‘åŒºåŸŸï¼ˆå‘ä¸Šï¼‰');
          updateDebugInfo('é‡æ–°è¿›å…¥', 1, video.currentTime, videoDuration);
          if (!video.paused) {
            video.pause();
          }
        },
        
        onLeaveBack: () => {
          console.log('ğŸ¬ ç¦»å¼€è§†é¢‘åŒºåŸŸï¼ˆå‘ä¸Šï¼‰');
          updateDebugInfo('ç¦»å¼€åŒºåŸŸ', 0, 0, videoDuration);
          video.currentTime = 0;
        }
      });

      console.log('âœ… ScrollTriggeråˆ›å»ºå®Œæˆ');
      console.log('ğŸ“ æ»šåŠ¨è·ç¦»:', scrollDist + 'px (' + scrollDistance + 'ä¸ªè§†å£é«˜åº¦)');

      // æ–‡å­—æ·¡å…¥åŠ¨ç”»
      gsap.fromTo('.video-overlay-content', 
        { opacity: 0, y: 30 },
        {
          opacity: 1,
          y: 0,
          duration: 1,
          scrollTrigger: {
            trigger: videoSection,
            start: 'top center',
            end: 'center center',
            scrub: 1
          }
        }
      );

      // çª—å£å¤§å°æ”¹å˜æ—¶åˆ·æ–°
      window.addEventListener('resize', () => {
        ScrollTrigger.refresh();
      });

    } catch (error) {
      console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
      updateDebugInfo('åˆå§‹åŒ–å¤±è´¥', 0, 0, 0);
    }
  }

  // å¯åŠ¨åˆå§‹åŒ–
  initVideoScroll();
</script>

<style>
  .video-scroll-section {
    position: relative;
    background: var(--bg-primary, #0a0a0a);
    overflow: hidden;
  }

  .video-pinned-container {
    position: relative;
    height: 100vh;
    min-height: 600px;
  }

  .video-media-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-secondary, #141414);
    overflow: hidden;
  }

  .scroll-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
    background: #000;
  }

  /* éšè—è§†é¢‘æ§ä»¶ */
  .scroll-video::-webkit-media-controls {
    display: none !important;
  }

  .scroll-video::-webkit-media-controls-play-button {
    display: none !important;
  }

  .scroll-video::-webkit-media-controls-start-playback-button {
    display: none !important;
    -webkit-appearance: none;
  }

  .video-overlay-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 2;
  }

  .video-overlay-wrapper {
    max-width: 800px;
    padding: 0 24px;
    text-align: center;
  }

  .video-overlay-content {
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 40px 32px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .video-title {
    font-family: "Playfair Display", "Noto Serif SC", Georgia, serif;
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    font-weight: 500;
    letter-spacing: 0.1em;
    color: var(--text-primary, #fafafa);
    margin-bottom: 16px;
  }

  .video-subtitle {
    font-size: clamp(1rem, 2.5vw, 1.25rem);
    line-height: 1.8;
    color: var(--gold-light, #e8d5a3);
    letter-spacing: 0.05em;
    margin: 0;
  }

  .debug-info {
    margin-top: 20px;
    font-family: monospace;
    font-size: 12px;
    color: #666;
    text-align: left;
  }

  .debug-info div {
    margin-bottom: 5px;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .video-pinned-container {
      min-height: 500px;
    }

    .video-overlay-content {
      padding: 32px 24px;
      margin: 0 16px;
    }

    .video-title {
      margin-bottom: 12px;
    }
  }

  /* å‡å°‘åŠ¨ç”»æ•ˆæœï¼ˆç”¨æˆ·åå¥½ï¼‰ */
  @media (prefers-reduced-motion: reduce) {
    .video-overlay-content {
      transition: none;
    }
  }
</style>