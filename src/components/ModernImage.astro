---
import { Picture } from 'astro:assets';
import type { ImageMetadata } from 'astro';

export interface Props {
  src: ImageMetadata;
  alt: string;
  widths?: number[];
  sizes?: string;
  loading?: 'lazy' | 'eager';
  fetchpriority?: 'high' | 'low' | 'auto';
  class?: string;
  imgClass?: string;
}

const {
  src,
  alt,
  widths = [400, 800, 1200],
  sizes = '100vw',
  loading = 'lazy',
  fetchpriority,
  class: containerClass = '',
  imgClass = ''
} = Astro.props;

const aspectRatio = src.width / src.height;
---

<div
  class:list={['modern-image', containerClass]}
  style={`--aspect-ratio: ${aspectRatio};`}
>
  <Picture
    src={src}
    alt={alt}
    widths={widths}
    sizes={sizes}
    formats={['avif', 'webp']}
    loading={loading}
    decoding="async"
    fetchpriority={fetchpriority}
    class:list={['modern-image__img', imgClass]}
  />
</div>

<style>
  .modern-image {
    position: relative;
    overflow: hidden;
    aspect-ratio: var(--aspect-ratio, 16/9);
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  }

  .modern-image__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .modern-image__img[data-loaded='true'],
  .modern-image :global(img) {
    opacity: 1;
  }

  /* Fallback for when JS is disabled */
  @media (scripting: none) {
    .modern-image__img {
      opacity: 1;
    }
  }
</style>

<script>
  document.querySelectorAll('.modern-image img').forEach((img) => {
    const imgEl = img as HTMLImageElement;
    const onLoad = () => {
      imgEl.style.opacity = '1';
    };
    if (imgEl.complete) {
      onLoad();
    } else {
      imgEl.addEventListener('load', onLoad, { once: true });
    }
  });
</script>
