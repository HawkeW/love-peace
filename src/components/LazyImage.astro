---
import { Picture, getImage } from 'astro:assets';
import type { ImageMetadata } from 'astro';

export interface Props {
  src: ImageMetadata | string;
  alt: string;
  class?: string;
  widths?: number[];
  sizes?: string;
}

const {
  src,
  alt,
  class: cls = '',
  widths = [400, 800],
  sizes = '100vw'
} = Astro.props;

const isImageMetadata = typeof src === 'object' && 'src' in src;

// Generate tiny placeholder for blur-up effect (only for local images)
let placeholder: { src: string } | null = null;
let aspectRatio = 16 / 9;

if (isImageMetadata) {
  placeholder = await getImage({
    src: src as ImageMetadata,
    width: 20,
    format: 'webp',
    quality: 20
  });
  aspectRatio = (src as ImageMetadata).width / (src as ImageMetadata).height;
}
---
{isImageMetadata ? (
  <div
    class:list={['lazy-wrapper', cls]}
    style={`--aspect-ratio: ${aspectRatio}; --placeholder: url(${placeholder?.src});`}
  >
    <Picture
      src={src as ImageMetadata}
      alt={alt}
      widths={widths}
      sizes={sizes}
      formats={['avif', 'webp']}
      loading="lazy"
      decoding="async"
      class="lazy-img"
    />
  </div>
) : (
  <div class:list={['lazy-wrapper', 'lazy-wrapper--simple', cls]}>
    <img
      src={src as string}
      alt={alt}
      loading="lazy"
      decoding="async"
      class="lazy-img"
    />
  </div>
)}

<script>
  const wrappers = document.querySelectorAll('.lazy-wrapper');
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const wrapper = entry.target as HTMLElement;
          const img = wrapper.querySelector('img');
          if (img) {
            const onLoad = () => {
              wrapper.classList.add('loaded');
            };
            if (img.complete) {
              onLoad();
            } else {
              img.addEventListener('load', onLoad, { once: true });
            }
          }
          observer.unobserve(wrapper);
        }
      });
    },
    { rootMargin: '50% 0px' }
  );
  wrappers.forEach((w) => observer.observe(w));
</script>

<style>
  .lazy-wrapper {
    position: relative;
    overflow: hidden;
    aspect-ratio: var(--aspect-ratio, 16/9);
    background-image: var(--placeholder);
    background-size: cover;
    background-position: center;
  }

  .lazy-wrapper--simple {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  }

  .lazy-wrapper:not(.lazy-wrapper--simple)::before {
    content: '';
    position: absolute;
    inset: 0;
    backdrop-filter: blur(20px);
    transition: opacity 0.4s ease;
  }

  .lazy-wrapper.loaded::before {
    opacity: 0;
    pointer-events: none;
  }

  .lazy-wrapper :global(picture) {
    display: contents;
  }

  .lazy-wrapper :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .lazy-wrapper.loaded :global(img) {
    opacity: 1;
  }
</style>

