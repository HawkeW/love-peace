---
import ParallaxLayout from '../layouts/ParallaxLayout.astro';
import PrismWrapper from '../components/backgrounds/PrismWrapper.vue';
import Ticket from '../components/Ticket.astro';
import fs from 'fs';
import path from 'path';
import ShinyText from '../components/ShinyText/ShinyText.vue';
import Masonry from '../components/Masonry.astro';
import { emitImageMetadata } from 'astro/assets/utils';

// Existing FS logic for Gallery
interface Item {
  id: string;
  img: string;
  url: string;
  alt: string;
  title: string;
  height: number;
  width: number;
}

const weddingDir = path.resolve(process.cwd(), 'public/gallery/wedding');
// Use try-catch or ensure directory exists to avoid build error if empty
let images: string[] = [];
try {
  if (fs.existsSync(weddingDir)) {
    images = fs.readdirSync(weddingDir).filter(f => /\.(jpe?g|png|webp)$/i.test(f));
  }
} catch (e) {
  console.error("Failed to read gallery directory", e);
}

const getGalleryItems = async () => {
  return await Promise.all(images.map(async (f) => {
    const base = f.replace(/\.(jpe?g|png|webp)$/i, '');
    const absPath = path.join(weddingDir, f);
    let width = 600;
    let height = 400;
  
    try {
      const result = await emitImageMetadata(absPath);
      if (result && result.width && result.height) {
        width = result.width;
        height = result.height;
      }
    } catch (e) {
      console.error(`Error reading dimensions for ${f}`, e);
    }
  
    return {
      id: base,
      img: `/gallery/wedding/${f}`,
      url: `/gallery/wedding/${f}`,
      alt: base,
      title: base,
      width,
      height,
    };
  }));
}

const galleryItems: Item[] = await getGalleryItems();

const eventTitle = '王浩&何晓雅';
const eventSub = '';
const coverImage = '/gallery/wedding/DXMJ2611.jpeg';
const eventAddress = '信阳市 艳阳天酒店';
const locationDesc = '信阳平桥区新六大街6号';
---

<ParallaxLayout title={eventTitle} description={eventSub} image={coverImage}>
  <!-- Hero Section -->
  <section id="hero" class="hero">
    <PrismWrapper client:load />
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <div class="brand">
        <span class="line"></span>
        <span class="brand-text">喜宴邀请函</span>
        <span class="line"></span>
      </div>
      <h1 class="title">{eventTitle}</h1>
      <p class="subtitle">{eventSub}</p>
      <div class="actions">
        <a href="#rsvp" class="btn btn-primary">
          <ShinyText client:load text="确认出席" />
        </a>
      </div>
    </div>
  </section>

  <!-- Gallery Section -->
  <section id="gallery" class="gallery-section">
    <h2>照片墙</h2>
    <Masonry items={galleryItems} />
  </section>

  <!-- Ticket Section -->
  <section id="ticket">
    <Ticket 
      location={eventAddress}
      locationDesc={locationDesc}
    />
  </section>
  <!-- Footer -->
  <footer class="footer">
    <p>Love & Peace · 2026</p>
  </footer>
</ParallaxLayout>

<style>
  /* Hero */
  .hero {
    height: 100vh;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #fff;
    overflow: hidden;
    max-width: 100vw;
  }

  .hero-overlay {
    position: absolute;
    inset: 0;
    background: radial-gradient(1200px 600px at 50% 30%, rgba(0,0,0,0.35), rgba(0,0,0,0.6));
    pointer-events: none;
    z-index: 0;
  }

  .hero-content {
    position: relative;
    z-index: 1;
    padding: var(--space-4);
    background: transparent;
    backdrop-filter: none;
    border-radius: 0;
    border: none;
    animation: fadeUp 1s var(--ease-out-expo) forwards;
    opacity: 0;
    transform: translateY(20px);
    text-shadow: 0 6px 20px rgba(0,0,0,0.4);
  }
  
  @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
  }

  .title {
    font-size: clamp(2.4rem, 8vw, 4.8rem);
    margin: 0 0 var(--space-2);
    letter-spacing: 0.08em;
    font-weight: 300;
    line-height: 1.1;
  }

  .subtitle {
    font-size: clamp(0.95rem, 3.2vw, 1.1rem);
    margin: 0 0 var(--space-6);
    opacity: 0.9;
    color: rgba(255,255,255,0.9);
  }

  .brand {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
    opacity: 0.9;
  }

  .brand .line {
    display: inline-block;
    width: 48px;
    height: 1px;
    background: rgba(255,255,255,0.5);
  }

  .brand .brand-text {
    font-size: 0.8rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.8);
  }

  .actions {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    margin-top: var(--space-2);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.65rem 1rem;
    border-radius: 999px;
    font-size: 0.95rem;
    letter-spacing: 0.06em;
    text-decoration: none;
    transition: transform 0.2s var(--ease-out-expo), opacity 0.2s;
    will-change: transform;
  }

  .btn:hover { transform: translateY(-1px); }

  .btn-outline {
    color: #fff;
    border: 1px solid rgba(255,255,255,0.6);
    background: rgba(255,255,255,0.06);
  }

  .btn-outline:hover { background: rgba(255,255,255,0.12); }

  .btn-primary {
    color: #fff;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.35);
    backdrop-filter: saturate(120%) blur(6px);
  }

  :global(.dark) .btn-primary { color: #fff; }

  .btn-primary:hover {
    background: rgba(255,255,255,0.18);
    border-color: rgba(255,255,255,0.45);
  }

  

  /* Sections */
  .gallery-section {
    padding: var(--space-8) var(--space-4);
    background: var(--color-bg-light);
    max-width: 100vw;
  }
  
  :global(.dark) .gallery-section {
      background: var(--color-bg-dark);
  }

  .gallery-section h2 {
    text-align: center;
    margin-bottom: var(--space-6);
    font-size: 1.8rem;
    color: var(--color-primary);
  }

  .schedule-section {
    padding: var(--space-8) var(--space-4);
    background: var(--color-bg-light);
  }
  
  :global(.dark) .schedule-section {
      background: var(--color-bg-dark);
  }

  .rsvp-section {
    padding: var(--space-8) var(--space-4);
    display: flex;
    justify-content: center;
    background: var(--color-bg-light);
    max-width: 100vw;
  }
  
  :global(.dark) .rsvp-section {
      background: var(--color-bg-dark);
  }

  .footer {
    text-align: center;
    padding: var(--space-6);
    opacity: 0.6;
    font-size: 0.9rem;
    max-width: 100vw;
  }
  
  :global(.dark) .footer {
      background: var(--color-bg-dark);
  }
  
  .map-link {
      margin-top: var(--space-2);
  }
  
  .map-link a {
      color: var(--color-primary);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s;
  }
  
  .map-link a:hover {
      border-color: currentColor;
  }

  .address { margin-top: var(--space-2); font-weight: 500; }
  .location-desc { margin-top: var(--space-1); opacity: 0.8; }
</style>
