---
import ParallaxLayout from '../layouts/ParallaxLayout.astro';
import Scene3D from '../components/hero/Scene3D.astro';
import StoryItem from '../components/story/StoryItem.astro';
import RSVPForm from '../components/interactive/RSVPForm.astro';
import Lightbox from '../components/Lightbox.astro';
import { slides } from '../data/slides';
import fs from 'fs';
import path from 'path';

// Existing FS logic for Gallery
interface Item {
  src: string;
  alt: string;
  title: string;
}

const weddingDir = path.resolve(process.cwd(), 'public/gallery/wedding');
// Use try-catch or ensure directory exists to avoid build error if empty
let images: string[] = [];
try {
  if (fs.existsSync(weddingDir)) {
    images = fs.readdirSync(weddingDir).filter(f => /\.(jpe?g|png|webp)$/i.test(f));
  }
} catch (e) {
  console.error("Failed to read gallery directory", e);
}

const galleryItems: Item[] = images.map((f) => {
  const base = f.replace(/\.(jpe?g|png|webp)$/i, '');
  return {
    src: `/gallery/wedding/${f}`,
    alt: base,
    title: base
  };
});

const eventTitle = 'Love & Peace';
const eventSub = '有些事，只有我们两个人在一起，才会有意义。';
const coverImage = '/gallery/wedding/DXMJ2611.jpeg'; // Default cover
---

<ParallaxLayout title={eventTitle} description={eventSub} image={coverImage}>
  <!-- Hero Section -->
  <section class="hero">
    <Scene3D />
    <div class="hero-content">
      <h1 class="title">{eventTitle}</h1>
      <p class="subtitle">{eventSub}</p>
      <div class="scroll-hint">
        <span>我们的故事</span>
        <div class="arrow">↓</div>
      </div>
    </div>
  </section>

  <!-- Story Section -->
  <section id="story" class="story-section">
    {slides.map((slide, index) => (
      <StoryItem 
        src={slide.src}
        title={slide.title}
        copy={slide.copy}
        index={index}
      />
    ))}
  </section>

  <!-- Gallery Section -->
  <section id="gallery" class="gallery-section">
    <h2>更多美好瞬间</h2>
    <div class="grid">
      {galleryItems.map((item, index) => (
        <figure class="item" data-index={index}>
          <img src={item.src} alt={item.alt} loading="lazy" decoding="async" />
        </figure>
      ))}
    </div>
  </section>

  <!-- RSVP Section -->
  <section id="rsvp" class="rsvp-section">
    <RSVPForm />
  </section>

  <!-- Footer -->
  <footer class="footer">
    <p>Love & Peace · 2026</p>
    <div class="map-link">
        <a href="https://maps.example.com" target="_blank" rel="noopener">查看地图</a>
    </div>
  </footer>

  <Lightbox selector=".grid .item img" />
</ParallaxLayout>

<style>
  /* Hero */
  .hero {
    height: 100vh;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--color-primary);
  }

  .hero-content {
    position: relative;
    z-index: 1;
    padding: var(--space-4);
    background: rgba(255,255,255,0.1); /* Fallback */
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    border-radius: 24px;
    border: 1px solid var(--glass-border);
    /* Animation for entry */
    animation: fadeUp 1s var(--ease-out-expo) forwards;
    opacity: 0;
    transform: translateY(20px);
  }
  
  @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
  }

  .title {
    font-size: clamp(2rem, 8vw, 4rem);
    margin: 0 0 var(--space-2);
    letter-spacing: 0.1em;
    font-weight: 200;
  }

  .subtitle {
    font-size: clamp(1rem, 4vw, 1.2rem);
    margin: 0 0 var(--space-4);
    opacity: 0.8;
    color: inherit;
  }

  .scroll-hint {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.9rem;
    opacity: 0.6;
    animation: bounce 2s infinite;
    color: var(--color-primary);
  }

  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
    40% { transform: translateX(-50%) translateY(-10px); }
    60% { transform: translateX(-50%) translateY(-5px); }
  }

  /* Sections */
  .story-section {
    background: var(--color-bg-light);
  }
  
  :global(.dark) .story-section {
      background: var(--color-bg-dark);
  }

  .gallery-section {
    padding: var(--space-8) var(--space-4);
    background: var(--color-bg-light);
  }
  
  :global(.dark) .gallery-section {
      background: var(--color-bg-dark);
  }

  .gallery-section h2 {
    text-align: center;
    margin-bottom: var(--space-6);
    font-size: 1.8rem;
    color: var(--color-primary);
  }

  .schedule-section {
    padding: var(--space-8) var(--space-4);
    background: var(--color-bg-light);
  }
  
  :global(.dark) .schedule-section {
      background: var(--color-bg-dark);
  }

  .grid {
    column-count: 2;
    column-gap: var(--space-2);
  }
  
  @media (min-width: 640px) {
    .grid { column-count: 3; }
  }
  
  @media (min-width: 1024px) {
    .grid { column-count: 4; }
  }

  .item {
    margin: 0 0 var(--space-2) 0;
    border-radius: 4px;
    overflow: hidden;
    break-inside: avoid; /* Prevent split across columns */
    cursor: zoom-in;
    transition: transform 0.3s var(--ease-out-expo), opacity 0.3s;
    /* Initial state for scroll reveal if we add it */
  }
  
  .item:hover {
      transform: scale(1.02);
      z-index: 2;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  .item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .rsvp-section {
    padding: var(--space-8) var(--space-4);
    display: flex;
    justify-content: center;
    background: var(--color-bg-light);
  }
  
  :global(.dark) .rsvp-section {
      background: var(--color-bg-dark);
  }

  .footer {
    text-align: center;
    padding: var(--space-6);
    opacity: 0.6;
    font-size: 0.9rem;
    background: var(--color-bg-light);
  }
  
  :global(.dark) .footer {
      background: var(--color-bg-dark);
  }
  
  .map-link {
      margin-top: var(--space-2);
  }
  
  .map-link a {
      color: var(--color-primary);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s;
  }
  
  .map-link a:hover {
      border-color: currentColor;
  }
</style>
